Great summary! Here’s a breakdown of how to address each issue, with actionable steps and C-specific context. I’ll also suggest a general approach for each, so you can map these to your codebase (likely in your `ts_tree_to_ast` logic and related AST-building code).

---

## 1. **Docstring Extraction**

**Problem:**  
Docstrings (comments at the top of files or before functions/classes) are missing in the AST.

**How to Fix:**
- **File-level docstring:**  
  - When building the root AST node, scan the start of the file for a block comment or line comments before any code.  
  - Attach this as the `docstring` field of the root node.
- **Function/Class docstrings:**  
  - When processing a function/class node, check for a comment immediately preceding its declaration.
  - Attach this as the node’s `docstring`.

**Implementation:**  
- Use Tree-sitter’s comment nodes, or scan the raw source text if Tree-sitter doesn’t expose comments.
- Update your AST builder to look for and attach these comments.

---

## 2. **Node Hierarchy / Nesting**

**Problem:**  
Variables and other constructs are not nested under their parent function/class nodes.

**How to Fix:**
- When traversing the Tree-sitter tree, ensure that:
  - Variables declared inside a function are added as children of that function node.
  - Methods are children of their class/struct node.
- Use a stack or recursive traversal to maintain the current parent node.

**Implementation:**  
- When you encounter a declaration, check the current parent context and attach accordingly.
- Avoid flattening all declarations to the root.

---

## 3. **Qualified Names**

**Problem:**  
`qualified_name` fields are missing or not fully qualified.

**How to Fix:**
- When building each node, construct its `qualified_name` by combining its parent’s `qualified_name` with its own name.
  - For example:  
    - File: `foo.c`  
    - Function: `foo.c.my_func`  
    - Method: `foo.c.MyClass.my_method`
- Store the parent’s qualified name as you traverse.

**Implementation:**  
- Pass the current qualified name down the recursion.
- Set `qualified_name` for each node as you build it.

---

## 4. **Signatures**

**Problem:**  
Function/method signatures are missing or incomplete.

**How to Fix:**
- When processing a function/method node, extract:
  - Return type
  - Name
  - Parameter list (with types and names)
- Build a string like `int foo(int x, float y)` and store it in the `signature` field.

**Implementation:**  
- Use Tree-sitter’s node types for function declarators and parameters.
- Concatenate the relevant text to form the signature.

---

## 5. **Node Types**

**Problem:**  
Some nodes are misclassified (e.g., variables as `UNKNOWN`).

**How to Fix:**
- Expand your mapping from Tree-sitter node types to your AST node types.
  - E.g., map `function_definition` to `FUNCTION`, `declaration` to `VARIABLE` (if it’s a variable), etc.
- Add logic to distinguish between variable, function, class, etc.

**Implementation:**  
- Update your node-type mapping function.
- Add more cases as needed for C constructs.

---

## 6. **Missing References / Call Graph Data**

**Problem:**  
`references` field is empty; function calls/variable references are not captured.

**How to Fix:**
- As you traverse function bodies, look for:
  - Function call expressions (e.g., `foo()`).
  - Variable usages.
- For each, add a reference object to the current node’s `references` array.

**Implementation:**  
- Use Tree-sitter queries to find call expressions and identifiers.
- Store the name and location of each reference.

---

## 7. **File-Level Node Handling**

**Problem:**  
Root node lacks metadata (file name, docstring).

**How to Fix:**
- When initializing the root AST node:
  - Set its `name` to the file name.
  - Set its `signature` to the file name or a descriptive string.
  - Attach the file-level docstring (see #1).

**Implementation:**  
- Ensure the root node is initialized with all required metadata before adding children.

---

## **General Implementation Plan**

1. **Review your AST builder (`ts_tree_to_ast` or similar):**
   - Identify where each of the above fields is set or missing.
2. **For each issue:**
   - Add/modify logic as described above.
   - Test with a minimal C file to ensure the field is now present and correct.
3. **Run your test suite after each fix.**
   - This will confirm that the change resolves the test failure.

---

## **If you want to proceed step-by-step:**
- Let me know which issue you want to tackle first, and I’ll walk you through the code changes needed for that part.
- Or, if you want a sample code snippet for any of the above, just ask!

Would you like to start with a specific issue, or see a sample implementation for one of these fixes?